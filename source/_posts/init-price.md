title: 页面价格初始化组件开发记
date: 2014-10-16 16:53:06
tags: 前端
---
本来，做这么个东西也没太大记录的必要，但是通过这个组件（其实就是一段小脚本）的开发，我有了一些别的感悟。考虑到给未来留个回忆，姑且写上一写。

<!--more-->

最初接到这个东西的需求时，我大概在做门店频道项目中的一个页面，那是我进入苏宁以后第一个参与的项目。8月的某天，老大突然喊了一嗓子，把我叫到他那里去捡肥皂，哦不是，布置任务。任务的需求是这样的，苏宁易购作为一家电商网站，运营部门总是会搞各种各样的促销活动，一天好几个都是有可能的。既然是活动，那么活动页面是免不了的，猛戳如下链接：
[苏宁活动页](http://sale.suning.com/images/advertise/005/body1013/index.html)
易购有这么多的活动页，网购研发中心的前端就这么多，当然不会去做这些繁琐的工作。生产这些页面的任务一般都是由运营部门自己的前端（说是前端，更多时候可能就是设计来兼任一下）来完成。他们的完成方式也很传统，通常拿着视觉给出的视觉稿大图，三下五除二从上到下垂直切成若干小块，用几个img标签标签包裹，往页面里一塞，再用Dreamweaver这样的工具把页面上的链接用map一个个框出来，填上url，搞定。一个做视觉的，前端造诣能这样已经不错了，现在的前端那么缺人。。。

然而这种开发方式虽然相当快，但有一个致命的缺点，那就是页面中所有商品的价格都是以图片方式呈现，电商之间的价格战如此激烈，商品价格的频繁变更是免不了的。一旦后台商品的价格变了，活动页上价格图片因为难以快速更新，就会出现用户在活动页上看到的价格和实时后台的价格不一致的情况，最终导致消费者的投诉，损害公司的信誉，这是个严重的问题（真的是很严重，我不止一次看到某些部门负责人因为一些这样的“价格欺诈”而遭到处罚甚至卷铺盖走人了）。

所以，运营那边提出的需求也很好猜了，由研发中心的前端开发部，提供页面价格实时更新的组件，使得每次刷新页面时异步从后台取得最新的价格，提供了脚本后，运营部门再做类似的活动页时，按照一定的规则编写HTML，引入我们提供的脚本，页面中所有用来填充价格的标签都会由JS异步填充价格。现有的资源只有后台提供的查询价格API一枚。

说实话在接到这个项目之前我一直认为这些活动页的价格本来就应该异步更新的，可事实上不是（但似乎也不是所有的活动页都有这个问题，有的页面价格就是最新的，可能是因为页面来源部门不同？）。拿某J网来说吧，他们的活动页中价格HTML标签上会填充商品编码有关的属性，如下：
``` javascript
<span class="jdNum" jshop="price" jdprice="1175126">2.90</span>
```
标签中`jshop`和`jdprice`两个属性用作取价格脚本的hook，在页面中异步填充了`script`标签来发起请求：
![](/img/script.png)
